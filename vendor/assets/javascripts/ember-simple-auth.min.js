// ============================================================================
// Project:   Simple Auth - Simple Authentication for Ember.js
// Copyright: ©2013 Marco Otte-Witte and contributors
//            ember.js is ©2011-2013 Tilde Inc.
// License:   Licensed under MIT license
//            See https://raw.github.com/simplabs/ember-simple-auth/master/LICENSE
// ============================================================================


!function(){"use strict";Ember.SimpleAuth={},Ember.SimpleAuth.setup=function(e,t,i){i=i||{},this.routeAfterLogin=i.routeAfterLogin||"index",this.routeAfterLogout=i.routeAfterLogout||"index",this.loginRoute=i.loginRoute||"login",this.serverTokenEndpoint=i.serverTokenEndpoint||"/token",this.autoRefreshToken=Ember.isEmpty(i.autoRefreshToken)?!0:!!i.autoRefreshToken,this.crossOriginWhitelist=Ember.A(i.crossOriginWhitelist||[]);var n=Ember.SimpleAuth.Session.create();t.register("simple_auth:session",n,{instantiate:!1,singleton:!0}),Ember.$.each(["model","controller","view","route"],function(e,i){t.inject(i,"session","simple_auth:session")}),Ember.$.ajaxPrefilter(function(e,t,i){!Ember.isEmpty(n.get("authToken"))&&Ember.SimpleAuth.includeAuthorizationHeader(e.url)&&i.setRequestHeader("Authorization","Bearer "+n.get("authToken"))}),this.includeAuthorizationHeader=function(e){function t(e){return e.protocol+"//"+e.hostname+(""!==e.port?":"+e.port:"")}this._links=this._links||{};var i=Ember.SimpleAuth._links[e]||function(){var t=document.createElement("a");return t.href=e,Ember.SimpleAuth._links[e]=t,t}(),n=t(i);return this._locationOrigin=t(window.location),this.crossOriginWhitelist.indexOf(n)>-1||n===this._locationOrigin},this.externalLoginSucceeded=function(t){n.setup(t),e.lookup("route:application").send("loginSucceeded")},this.externalLoginFailed=function(t){e.lookup("route:application").send("loginFailed",t)}}}(),function(){"use strict";Ember.SimpleAuth.Session=Ember.Object.extend({init:function(){this._super(),this.syncProperties(),this.handleAuthTokenRefresh()},setup:function(e){e=e||{},this.setProperties({authToken:e.access_token,refreshToken:e.refresh_token||this.get("refreshToken"),authTokenExpiry:(e.expires_in>0?1e3*e.expires_in:this.get("authTokenExpiry"))||0})},destroy:function(){this.setProperties({authToken:void 0,refreshToken:void 0,authTokenExpiry:void 0})},isAuthenticated:Ember.computed("authToken",function(){return!Ember.isEmpty(this.get("authToken"))}),syncProperties:function(){this.setProperties({authToken:this.load("authToken"),refreshToken:this.load("refreshToken"),authTokenExpiry:this.load("authTokenExpiry")}),Ember.testing||(Ember.run.cancel(Ember.SimpleAuth.Session._syncPropertiesTimeout),Ember.SimpleAuth.Session._syncPropertiesTimeout=Ember.run.later(this,this.syncProperties,500))},load:function(e){var t=document.cookie.match(new RegExp(e+"=([^;]+)"))||[];return Ember.isEmpty(t)?void 0:decodeURIComponent(t[1]||"")},store:function(e){document.cookie=e+"="+encodeURIComponent(this.get(e)||"")},authTokenObserver:Ember.observer(function(){this.store("authToken")},"authToken"),refreshTokenObserver:Ember.observer(function(){this.store("refreshToken"),this.handleAuthTokenRefresh()},"refreshToken"),authTokenExpiryObserver:Ember.observer(function(){this.store("authTokenExpiry"),this.handleAuthTokenRefresh()},"authTokenExpiry"),handleAuthTokenRefresh:function(){if(Ember.SimpleAuth.autoRefreshToken){Ember.run.cancel(Ember.SimpleAuth.Session._refreshTokenTimeout),Ember.SimpleAuth.Session._refreshTokenTimeout=void 0;var e=this.get("authTokenExpiry")-5e3;!Ember.isEmpty(this.get("refreshToken"))&&e>0&&(Ember.SimpleAuth.Session._refreshTokenTimeout=Ember.run.later(this,function(){var e=this;Ember.$.ajax(Ember.SimpleAuth.serverTokenEndpoint,{type:"POST",data:"grant_type=refresh_token&refresh_token="+this.get("refreshToken"),contentType:"application/x-www-form-urlencoded"}).then(function(t){e.setup(t),e.handleAuthTokenRefresh()})},e))}}})}(),function(){"use strict";Ember.SimpleAuth.AuthenticatedRouteMixin=Ember.Mixin.create({beforeModel:function(e){this.get("session.isAuthenticated")||(e.abort(),this.triggerLogin(e))},triggerLogin:function(e){this.set("session.attemptedTransition",e),Ember.canInvoke(e,"send")?e.send("login"):this.send("login")}})}(),function(){"use strict";Ember.SimpleAuth.LoginControllerMixin=Ember.Mixin.create({tokenRequestOptions:function(e,t,i,n){var o={grant_type:"password",username:e,password:t};return Ember.isEmpty(i)||(o.client_id=i,Ember.isEmpty(n)||(o.client_secret=n)),{type:"POST",data:o,contentType:"application/x-www-form-urlencoded"}},actions:{login:function(){var e=this,t=this.getProperties("identification","password","client_id","client_secret");if(!Ember.isEmpty(t.identification)&&!Ember.isEmpty(t.password)){this.set("password",void 0);var i=this.tokenRequestOptions(t.identification,t.password,t.client_id,t.client_secret);Ember.$.ajax(Ember.SimpleAuth.serverTokenEndpoint,i).then(function(t){Ember.run(function(){e.get("session").setup(t),e.send("loginSucceeded")})},function(t,i,n){Ember.run(function(){e.send("loginFailed",t,i,n)})})}}}})}(),function(){"use strict";Ember.SimpleAuth.ApplicationRouteMixin=Ember.Mixin.create({actions:{login:function(){this.transitionTo(Ember.SimpleAuth.loginRoute)},loginSucceeded:function(){var e=this.get("session.attemptedTransition");e?(e.retry(),this.set("session.attemptedTransition",void 0)):this.transitionTo(Ember.SimpleAuth.routeAfterLogin)},loginFailed:function(){},logout:function(){this.get("session").destroy(),this.transitionTo(Ember.SimpleAuth.routeAfterLogout)}}})}();